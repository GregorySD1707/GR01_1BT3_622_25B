@startuml

' --- Configuración Visual ---
skinparam package {
  BackgroundColor LightGray
  BorderColor Gray
}

' --- Capa de Acceso a Datos (Base) ---
package "Capa de Datos (DAO)" <<Database>> {
  abstract class DAOBase <<abstract>> {
    + crear(entity: T): void
    + borrar(id: Long): void
    + actualizar(entity: T): void
    + buscarPorId(id: Long): T
    + listar(): List<T>
    + listar(maxResults: int, firstResult: int): List<T>
    - listar(all: boolean, maxResults: int, firstResult: int): List<T>
  }
}

' --- Módulo Principal de la Aplicación ---
class Inicio

' --- Modulo de Movimientos ---
package "Gestion de Movimientos" #LightBlue {
  class ServicioMovimientos {
    - movimientoDAO: DAOMovimiento
    - carteraDAO: CarteraDAO
    + registrarIngreso(monto: double, descripcion: String, categoria: String, nombreCartera: String): Ingreso
    + registrarGasto(monto: double, descripcion: String, categoria: String, nombreCartera: String): Gasto
    + actualizarCartera(delta: double, nombreCartera: String, tipoSiNoExiste: String): Cartera
    + obtenerIngresosTotales(): double
    + obtenerGastosTotales(): double
    + obtenerSaldoActualTotal(): double
    - validarMonto(monto: double)
  }

  abstract class Movimiento <<abstract>> {
    - id: Long
    - monto: double
    - fecha: LocalDateTime
    - descripcion: String
    - categoria: String
  }

  class Ingreso
  class Gasto

  class Cartera {
    - id: Long
    - nombre: String
    - saldoActual: double
    - tipo: String
    + actualizarCartera(delta: double): void
  }

  class DAOMovimiento {
    + sumIngresos(): double
    + sumGastos(): double
  }

  class CarteraDAO {
    + buscarPorNombre(nombre: String): Cartera
    + obtenerOCrear(nombre: String, tipo: String): Cartera
    + sumSaldoActual(): double
  }

  class ServletMovimientos {
    + mostrarResumen(): void
    + registrarIngreso(monto: double, descripcion: String, categoria: String, nombreCartera: String): void
    + registrarGasto(monto: double, descripcion: String, categoria: String, nombreCartera: String): void
  }
}
' --- Módulo de Deudas ---
package "Gestión de Deudas" #LightGreen {
  class ServletDeudas {
    + registrarDeuda(nombrePersona: String, montoTotal: double, fechaPago: LocalDate, tipo: TipoDeudaPrestamo): void
    + abonarADeuda(idDeuda: Long, monto: double): void
    + listarDeudas(): void
  }

  class ServicioDeudas {
    - daoDeudaPrestamo: DAODeudaPrestamo
    - servicioMovimientos: ServicioMovimientos
    + registrarDeuda(nombrePersona: String, montoTotal: double, fechaPago: LocalDate): DeudaPrestamo
    + registrarPrestamo(nombrePersona: String, montoTotal: double, fechaPago: LocalDate): DeudaPrestamo
    + abonarADeuda(idDeuda: Long, monto: double): void
    + obtenerDeudasPendientes(): List<DeudaPrestamo>
    + obtenerPorPersona(nombrePersona: String): List<DeudaPrestamo>
  }

  class DeudaPrestamo {
    - id: Long
    - nombrePersona: String
    - montoTotal: double
    - montoPagado: double
    - fechaPago: LocalDate
    - tipo: TipoDeudaPrestamo
    - estado: EstadoDeudaPrestamo
    + calcularSaldoPendiente(): double
    + registrarAbono(monto: double)
  }

  class DAODeudaPrestamo {
    + listarPorPersona(nombrePersona: String): List<DeudaPrestamo>
    + listarPendientes(): List<DeudaPrestamo>
  }

  enum TipoDeudaPrestamo {
    DEUDA
    PRESTAMO
  }

  enum EstadoDeudaPrestamo {
    PENDIENTE
    PAGADA
    VENCIDA
  }

  ' Relaciones
  ServletDeudas o-- ServicioDeudas : usa
  ServicioDeudas *-- DAODeudaPrestamo : contiene
  ServicioDeudas o-- ServicioMovimientos : usa
  ServicioDeudas o-- DeudaPrestamo : gestiona
  DAODeudaPrestamo o-- DeudaPrestamo : persiste
  DeudaPrestamo o-- TipoDeudaPrestamo : tipo
  DeudaPrestamo o-- EstadoDeudaPrestamo : estado
}

' --- Módulo de Recordatorios ---
package "Recordatorios" #LightYellow {
  class ServletRecordatorio  {
    - recordatorioDAO: RecordatorioDAO
    - listarRecordatorios(): void
    - mostrarFormulario(recordatorio: Recordatorio): void
    - mostrarFormularioEditar(): void
    - construirRecordatorioDesdeRequest(): Recordatorio
    - crearRecordatorio(): void
    - actualizarRecordatorio(): void
    - borrarRecordatorio(): void
  }

  class ServletNotificacion  {
    - recordatorioDAO: RecordatorioDAO
    - gson: Gson
  }

  class Recordatorio {
    - id: Long
    - fechaInicio: LocalDate
    - fechaFin: LocalDate
    - descripcion: String
    - recurrencia: Recurrencia
    - diasDeAnticipacion: int
    - monto: double
    + obtenerFechaVencimiento(hoy: LocalDate): Optional<LocalDate>
    - calcularProximaFechaVencimiento(desde: LocalDate): LocalDate
  }

  enum Recurrencia {
    NINGUNA
    DIARIA
    SEMANAL
    MENSUAL
    ANUAL
  }

  class RecordatorioDAO {
    + listarActivos(): List<Recordatorio>
  }
}

' --- Módulo de Resumen ---
package "Resumen Financiero" #LightSalmon {
  class ControladorResumenFinanciero {
    + registrarResumenFinanciero(): ResumenFinanciero
    + consultarResumenFinanciero(id: String): ResumenFinanciero
    + subirArchivo()
    + procesarInformacion()
  }

  class ResumenFinanciero {
    - ingresosTotales: double
    - gastosTotales: double
    - ahorroNeto: double
  }

  ' DAO del módulo
  class ResumenFinancieroDAO
}


' ===================================
'      DEFINICIÓN DE RELACIONES
' ===================================

' --- Relaciones del Nivel Superior (Inicio -> Controladores) ---
Inicio o-- ServletDeudas
Inicio o-- ServletMovimientos
Inicio "1" o-- "1" ServletRecordatorio
Inicio "1" o-- "1" ServletNotificacion
Inicio o-- ControladorResumenFinanciero


' --- Relaciones dentro del paquete de Movimientos ---
ServicioMovimientos ..> Movimiento
ServicioMovimientos ..> Cartera
ServicioMovimientos *-- DAOMovimiento
ServicioMovimientos *-- CarteraDAO
ServletMovimientos o-- ServicioMovimientos : usa
ServletMovimientos ..> Movimiento : muestra
Movimiento <|-- Ingreso
Movimiento <|-- Gasto

' --- Relaciones dentro del paquete de Recordatorios ---
ServletRecordatorio "1" *-- "1" RecordatorioDAO : contiene
ServletRecordatorio "1" ..> "*" Recordatorio : maneja
ServletRecordatorio "1" ..> "*" Recurrencia : utiliza
ServletNotificacion "1" *-- "1" RecordatorioDAO : contiene
ServletNotificacion "1" ..> "*" Recordatorio : consulta
Recordatorio "1" *-- "1" Recurrencia : tiene
RecordatorioDAO "1" ..> "*" Recordatorio : persiste
ControladorResumenFinanciero ..> ResumenFinanciero
ControladorResumenFinanciero *-- ResumenFinancieroDAO


' --- Relaciones ENTRE paquetes (Colaboraciones) ---
' Pagar una deuda usa el servicio de movimientos para registrar el gasto


' --- Herencia de la Capa de Datos (DAO) ---
DAOBase <|-- RecordatorioDAO
DAOBase <|-- DAOMovimiento
DAOBase <|-- CarteraDAO
DAOBase <|-- DAODeudaPrestamo
DAOBase <|-- ResumenFinancieroDAO

@enduml